#!/bin/sh -e

case "$0" in
    */*)
	cd $(dirname $0)
	;;
esac

trap 'rm -f src/src.mk lib/medida.mk lib/lib.mk' 0

message="# This file was generated by make-mks; don't edit it by hand."

(cd src
 echo "$message"
 echo "SRC_H_FILES" = $(find . -type f \( -name '*.h' -o -name '*.ipp' -o -name '*.hpp' \))
 echo "SRC_CXX_FILES" = $(find . -type f -name '*.cpp')
 echo "SRC_X_FILES" = $(find . -type f -name '*.x')
) > src/src.mk


# Hacks for shell third-party libraries without autoconf.  You may
# need to re-run this after updating submodules.

listall() {
    find "$@" -type f \
	 \( -name '*.[ch]' -o -name '*.[chi]pp' -o -name '*.cc' \) -print
}

(cd lib
 if test -f libmedida/src/medida/medida.h; then
     echo "$message"
     echo INTERNAL_MEDIDA_FILES = $(listall libmedida/src/medida)
 fi) > lib/medida.mk

(cd lib
 echo "$message"
 echo SOCI_FILES = $(listall soci/src/backends/sqlite3 soci/src/core)
 echo SOCI_PG_FILES = $(listall soci/src/backends/postgresql)

 echo SQLITE3_FILES = $(listall sqlite)
 echo UTIL_FILES = $(listall util http)
 echo ASIO_H_FILES = $(listall asio/include)
 # The following does not work without boost or -DASIO_STANDALONE=1
 #echo ASIO_CXX_FILES = asio/src/*.cpp
 echo ASIO_CXX_FILES = asio/src/asio.cpp
 echo JSON_FILES = $(listall json)

 echo MISC_H_FILES = *.hpp $(listall autocheck cereal)
) > lib/lib.mk

trap '' 0
